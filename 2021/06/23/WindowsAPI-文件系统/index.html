<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"systemk1t.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="最近在学习 Win32编程，所以顺便将每日所学记录下来，一方面为了巩固学习的知识，另一方面也为同样在学习Win32开发的童鞋们提供一份参考。 本系列博文均根据学习《WindowsAPI开发详解》一书总结而来；">
<meta property="og:type" content="article">
<meta property="og:title" content="WindowsAPI - 文件系统">
<meta property="og:url" content="http://systemk1t.github.io/2021/06/23/WindowsAPI-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="sYstemk1t&#39;s blog">
<meta property="og:description" content="最近在学习 Win32编程，所以顺便将每日所学记录下来，一方面为了巩固学习的知识，另一方面也为同样在学习Win32开发的童鞋们提供一份参考。 本系列博文均根据学习《WindowsAPI开发详解》一书总结而来；">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-06-23T12:12:35.000Z">
<meta property="article:modified_time" content="2021-06-24T12:00:25.620Z">
<meta property="article:author" content="sYstemk1t">
<meta property="article:tag" content="WindowsAPI开发详解">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://systemk1t.github.io/2021/06/23/WindowsAPI-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>WindowsAPI - 文件系统 | sYstemk1t's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">sYstemk1t's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://systemk1t.github.io/2021/06/23/WindowsAPI-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sYstemk1t">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sYstemk1t's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          WindowsAPI - 文件系统
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-23 20:12:35" itemprop="dateCreated datePublished" datetime="2021-06-23T20:12:35+08:00">2021-06-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-24 20:00:25" itemprop="dateModified" datetime="2021-06-24T20:00:25+08:00">2021-06-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WindowsAPI%E5%BC%80%E5%8F%91%E8%AF%A6%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">WindowsAPI开发详解</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>29k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>27 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>最近在学习 Win32编程，所以顺便将每日所学记录下来，一方面为了巩固学习的知识，另一方面也为同样在学习Win32开发的童鞋们提供一份参考。</p>
<p>本系列博文均根据学习《WindowsAPI开发详解》一书总结而来；</p>
<a id="more"></a>

<p>运行环境：</p>
<ul>
<li>操作系统： Windows 10家庭版</li>
<li>编译器：Visual Studio 2013</li>
</ul>
<h1 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h1><p>文件系统是操作系统最重要的组成，支持操作系统运行的系统可执行文件本身也位于文件系统中。</p>
<h2 id="文件系统概念"><a href="#文件系统概念" class="headerlink" title="文件系统概念"></a>文件系统概念</h2><p>Windows操作系统的文件虽然具有FAT16、FAT32、NTFS等多种格式；</p>
<p>对文件系统进行开发时，所设计一些概念包括磁盘分区、卷、目录、文件对象、文件句柄、文件映射等。</p>
<ul>
<li>磁盘分区<ul>
<li>磁盘是装在计算机上的存储设备，硬盘就是常见的存储设备，可以对硬盘进行分为多个独立的逻辑驱动器</li>
</ul>
</li>
<li>卷<ul>
<li>卷也成为逻辑驱动器，一个磁盘分区最少拥有一个卷。卷也可以分为多个磁盘分区上；</li>
</ul>
</li>
<li>Windows中文件命名标准<ul>
<li>Windows系统中，文件命名格式为”主文件名 + 扩展名”</li>
<li>文件路径长度应限制再260个字符以内。</li>
<li>不允许使用特殊符号</li>
</ul>
</li>
</ul>
<p>磁盘和驱动器管理API<br><strong>GetLogicalDrivers    获取主机中所有的逻辑驱动器,以Bit Map的形式返回.<br>GetLogicalDriverString   获取主机中所有的逻辑驱动器,以驱动器根路径字符串返回.<br>FindFirstVolume   查找主机中的第一个驱动器，返回查找句柄.<br>FindNextVolume    根据FindFirstVolume返回句柄,查找主机中后继的逻辑驱动器<br>FindVolumeClose   关闭驱动器查找句柄<br>GetDriveType    获取驱动器类型<br>GetVolumeInformation   获取逻辑驱动器信息<br>FindFirstVolumeMountPoint 查找指定卷的第一个挂载点,返回查找句柄<br>FindNextVolumeMountPoint 根据FindFirstVolumeMountPoint返回的句柄,查找卷的后继挂载点.<br>FindVolumeMountPointClose 关闭挂载点查找句柄<br>GetVolumeNameForVolumeMountPoint 根据指定挂载点获取相应的卷设备名<br>SetVolumeMountPoint     将指定卷挂载到指定挂载点处<br>GetDiskFreeSpace      获取磁盘空间信息,包括每簇的扇区数,每扇区的字节数,簇数量,空闲的簇数量<br>GetDiskFreeSpaceEx     获取用户可用的空闲空间的字节数,磁盘总容量的字节数</strong></p>
<p><strong>文件和目录管理API<br>DeleteFile         删除参数所指定文件<br>CopyFile          复制指定文件为一个新文件<br>MoveFile          将指定文件或目录移动到指定位置<br>CreateFile         新建或打开一个文件,获取文件句柄<br>ReadFile          读取由文件句柄指定文件的内容<br>WriteFile          向由文件句柄指定的文件中写入内容<br>GetFileSize         获取文件大小,返回DWORD中;大小超出DWORD最大值时可指定高32位的DWORD联合存储<br>GetFileSizeEx        获取文件大小,存储到一个64位的大整数联合体中.<br>CreateDirectory       创建一个目录<br>GetCurrentDirectory     获取当前程序所在目录<br>SetCurrentDirectory     设置当前程序所在目录<br>GetModuleFileName      获取当前模块全路径<br>FindFirstFile        查找指定目录下第一个文件句柄或目录,获得查找句柄<br>FindNextFile        根据FindFirstFile获得的句柄,循环查找文件或目录<br>GetFileAttributes      获取指定文件目录属性,返回一个DWORD值<br>GetFileAttributesEx     获取文件或目录属性,存储在WIN32_FILE_ATTRIBUTE_DATA结构体中<br>SetFileAttributes      将文件属性设定为指定值<br>FileTimeToLocalFileTime   将文件时间转换为本地时间<br>FileTimeToSystemTime    将文件转换为系统时间,SYSTEMTIME格式便于显示</strong></p>
<p><strong>高级文件操作<br>CreateFileMapping      创建文件的映射对象<br>MapViewOfFile        创建视图,将创建的文件映射对象映射到当前进程的地址空间中<br>FlushViewOfFile       将视图中的数据都写入磁盘,对视图的操作都会反映到磁盘上的文件中<br>OpenFileMapping       打开已经存在的命名的文件映射对象<br>UnmapViewOfFile       取消文件映射<br>GetMappedFileName      从映射对象获取被映射文件的文件设备名<br>QueryDosDevice       获取MS-DOS设备名</strong></p>
<h2 id="磁盘和驱动器"><a href="#磁盘和驱动器" class="headerlink" title="磁盘和驱动器"></a>磁盘和驱动器</h2><ul>
<li>使用两种方法来遍历驱动器并获取驱动器属性。</li>
<li>使用API操作驱动器挂载点。</li>
<li>判断光驱中是否有光盘。</li>
<li>获取磁盘剩余空间、扇区信息等。</li>
</ul>
<h3 id="遍历卷获得属性"><a href="#遍历卷获得属性" class="headerlink" title="遍历卷获得属性"></a>遍历卷获得属性</h3><p>(1) GetLogicalDrives。<br>获取主机中所有的逻辑驱动器，以BitMap的形式返回，其函数原型如下：</p>
<p>(2) GetLogicalDriverStrings。<br>获取主机中所有驱动器，以驱动器根路径字符串返回，其函数原型如下：</p>
<p>（3）FindFirstVolume。<br>查找主机中的第一个驱动器，返回驱动器设备名，其函数原型如下：</p>
<p>（4）FindNextVolume<br>查找主机中后继的逻辑驱动器，其函数原型如下：</p>
<p>(5）FindVo1umeClose。<br>关闭FindFirstVolume打开的卷遍历句柄，其函数原型如下：</p>
<p>(6) GetDriveType。<br>获取驱动器类型，其函数原型如下：</p>
<p>(7) GetVolumeInformation。<br>获取逻辑驱动器信息，其函数原型如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment"> *《精通Windows API》 </span></span><br><span class="line"><span class="comment"> * 示例代码</span></span><br><span class="line"><span class="comment"> * GetVolumeInfo.c</span></span><br><span class="line"><span class="comment"> * 4.2.1	遍历驱动器并获取驱动器属性</span></span><br><span class="line"><span class="comment"> **************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 头文件　*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">/* 预定义　*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFSIZE 1024</span></span><br><span class="line"><span class="comment">/* 函数申明　*/</span></span><br><span class="line"><span class="function">BOOL <span class="title">GetDirverInfo</span><span class="params">(LPSTR szDrive)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment"> * 功能	应用程序主函数，遍历驱动器并调用</span></span><br><span class="line"><span class="comment"> *			GetDirverInfo 获取驱动器属性</span></span><br><span class="line"><span class="comment"> **************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CHAR szLogicalDriveStrings[BUFSIZE];</span><br><span class="line">	PCHAR szDrive;</span><br><span class="line"></span><br><span class="line">	ZeroMemory(szLogicalDriveStrings,BUFSIZE);</span><br><span class="line">	<span class="comment">// 获取逻辑驱动器卷标名</span></span><br><span class="line">	GetLogicalDriveStrings(BUFSIZE - <span class="number">1</span>,szLogicalDriveStrings);	</span><br><span class="line">	szDrive = (PCHAR)szLogicalDriveStrings;</span><br><span class="line">	<span class="comment">// 循环处理每个卷</span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(!GetDirverInfo(szDrive))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\nGet Volume Information Error: %d&quot;</span>, GetLastError());</span><br><span class="line">		&#125;</span><br><span class="line">		szDrive += (lstrlen(szDrive)+<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span>(*szDrive!=<span class="string">&#x27;\x00&#x27;</span>);</span><br><span class="line">	getchar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment"> * BOOL GetDirverInfo(LPSTR szDrive)</span></span><br><span class="line"><span class="comment"> * 功能	获取驱动器的属性</span></span><br><span class="line"><span class="comment"> * 参数	LPSTR szDrive</span></span><br><span class="line"><span class="comment"> * 	指明要获取属性的驱动器的根路径 如 C:\</span></span><br><span class="line"><span class="comment"> * 返回值 BOOL 是否成功</span></span><br><span class="line"><span class="comment"> **************************************/</span></span><br><span class="line"><span class="function">BOOL <span class="title">GetDirverInfo</span><span class="params">(LPSTR szDrive)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UINT uDriveType;</span><br><span class="line">	DWORD dwVolumeSerialNumber;</span><br><span class="line">	DWORD dwMaximumComponentLength;</span><br><span class="line">	DWORD dwFileSystemFlags;</span><br><span class="line">	TCHAR szFileSystemNameBuffer[BUFSIZE];</span><br><span class="line">	TCHAR szRootName[BUFSIZE];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n%s\n&quot;</span>,szDrive);</span><br><span class="line">	uDriveType = GetDriveType(szDrive);</span><br><span class="line">	<span class="comment">// 判断类型</span></span><br><span class="line">	<span class="keyword">switch</span>(uDriveType)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_UNKNOWN:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive type cannot be determined. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_NO_ROOT_DIR:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The root path is invalid, for example, no volume is mounted at the path. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_REMOVABLE:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive is a type that has removable media, for example, a floppy drive or removable hard disk. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_FIXED:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive is a type that cannot be removed, for example, a fixed hard drive. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_REMOTE:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive is a remote (network) drive. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_CDROM:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive is a CD-ROM drive. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_RAMDISK:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive is a RAM disk. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!GetVolumeInformation(</span><br><span class="line">		szDrive, szRootName, BUFSIZE,</span><br><span class="line">		&amp;dwVolumeSerialNumber,</span><br><span class="line">		&amp;dwMaximumComponentLength,</span><br><span class="line">		&amp;dwFileSystemFlags,</span><br><span class="line">		szFileSystemNameBuffer,</span><br><span class="line">		BUFSIZE</span><br><span class="line">		))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span> (<span class="string">&quot;\nVolume Serial Number is %u&quot;</span>,dwVolumeSerialNumber);</span><br><span class="line">	<span class="built_in">printf</span> (<span class="string">&quot;\nMaximum Component Length is %u&quot;</span>,dwMaximumComponentLength);</span><br><span class="line">	<span class="built_in">printf</span> (<span class="string">&quot;\nSystem Type is %s\n&quot;</span>,szFileSystemNameBuffer);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\RootName is %s\n&quot;</span>, szRootName);</span><br><span class="line">	<span class="keyword">if</span>(dwFileSystemFlags &amp; FILE_SUPPORTS_REPARSE_POINTS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span> (<span class="string">&quot;The file system does not support volume mount points.\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(dwFileSystemFlags &amp; FILE_VOLUME_QUOTAS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span> (<span class="string">&quot;The file system supports disk quotas.\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(dwFileSystemFlags &amp; FILE_CASE_SENSITIVE_SEARCH)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span> (<span class="string">&quot;The file system supports case-sensitive file names.\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//you can use these value to get more informaion</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//FILE_CASE_PRESERVED_NAMES</span></span><br><span class="line">	<span class="comment">//FILE_CASE_SENSITIVE_SEARCH</span></span><br><span class="line">	<span class="comment">//FILE_FILE_COMPRESSION</span></span><br><span class="line">	<span class="comment">//FILE_NAMED_STREAMS</span></span><br><span class="line">	<span class="comment">//FILE_PERSISTENT_ACLS</span></span><br><span class="line">	<span class="comment">//FILE_READ_ONLY_VOLUME</span></span><br><span class="line">	<span class="comment">//FILE_SUPPORTS_ENCRYPTION</span></span><br><span class="line">	<span class="comment">//FILE_SUPPORTS_OBJECT_IDS</span></span><br><span class="line">	<span class="comment">//FILE_SUPPORTS_REPARSE_POINTS</span></span><br><span class="line">	<span class="comment">//FILE_SUPPORTS_SPARSE_FILES</span></span><br><span class="line">	<span class="comment">//FILE_UNICODE_ON_DISK</span></span><br><span class="line">	<span class="comment">//FILE_VOLUME_IS_COMPRESSED</span></span><br><span class="line">	<span class="comment">//FILE_VOLUME_QUOTAS</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;...\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>使用FindFirstVolume遍历驱动器</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">*《精通Windows API》</span></span><br><span class="line"><span class="comment">* 示例代码</span></span><br><span class="line"><span class="comment">* Enumeratevolume.c</span></span><br><span class="line"><span class="comment">* 4.2.1	遍历驱动器并获取驱动器属性</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WIN32_WINNT 0x0501</span></span><br><span class="line"><span class="comment">/* 头文件　*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">/* 预定义　*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFSIZE            MAX_PATH</span></span><br><span class="line"><span class="comment">/* 函数申明　*/</span></span><br><span class="line"><span class="function">BOOL <span class="title">GetDirverInfo</span><span class="params">(LPTSTR szDrive)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">* 功能	应用程序主函数，遍历驱动器并调用</span></span><br><span class="line"><span class="comment">*		GetDirverInfo 获取驱动器属性</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TCHAR buf[BUFSIZE];      <span class="comment">// 卷标信息</span></span><br><span class="line">	HANDLE hVol;             <span class="comment">// 卷遍历句柄</span></span><br><span class="line">	BOOL bFlag;</span><br><span class="line"></span><br><span class="line">	hVol = FindFirstVolume(buf, BUFSIZE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hVol == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;No volumes found!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> (<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	GetDirverInfo(buf);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (FindNextVolume(</span><br><span class="line">		hVol,</span><br><span class="line">		buf,</span><br><span class="line">		BUFSIZE</span><br><span class="line">		))</span><br><span class="line">	&#123;</span><br><span class="line">		GetDirverInfo(buf);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bFlag = FindVolumeClose(</span><br><span class="line">		hVol</span><br><span class="line">		);</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> (bFlag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">* BOOL GetDirverInfo(LPSTR szDrive)</span></span><br><span class="line"><span class="comment">* 功能	获取驱动器的属性</span></span><br><span class="line"><span class="comment">* 参数	LPSTR szDrive</span></span><br><span class="line"><span class="comment">* 	指明要获取属性的驱动器的根路径 如 C:\</span></span><br><span class="line"><span class="comment">* 返回值 BOOL 是否成功</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"><span class="function">BOOL <span class="title">GetDirverInfo</span><span class="params">(LPTSTR szDrive)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UINT uDriveType;</span><br><span class="line">	DWORD dwVolumeSerialNumber;</span><br><span class="line">	DWORD dwMaximumComponentLength;</span><br><span class="line">	DWORD dwFileSystemFlags;</span><br><span class="line">	TCHAR szFileSystemNameBuffer[BUFSIZE];</span><br><span class="line">	TCHAR szDirveName[MAX_PATH];</span><br><span class="line">	wprintf(TEXT(<span class="string">&quot;\n%s\n&quot;</span>), szDrive);</span><br><span class="line">	uDriveType = GetDriveType(szDrive);</span><br><span class="line">	<span class="keyword">switch</span> (uDriveType)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_UNKNOWN:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive type cannot be determined. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_NO_ROOT_DIR:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The root path is invalid, for example, no volume is mounted at the path. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_REMOVABLE:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive is a type that has removable media, for example, a floppy drive or removable hard disk. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_FIXED:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive is a type that cannot be removed, for example, a fixed hard drive. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_REMOTE:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive is a remote (network) drive. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_CDROM:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive is a CD-ROM drive. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DRIVE_RAMDISK:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The drive is a RAM disk. &quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!GetVolumeInformation(</span><br><span class="line">		szDrive,</span><br><span class="line">		szDirveName,</span><br><span class="line">		MAX_PATH,</span><br><span class="line">		&amp;dwVolumeSerialNumber,</span><br><span class="line">		&amp;dwMaximumComponentLength,</span><br><span class="line">		&amp;dwFileSystemFlags,</span><br><span class="line">		szFileSystemNameBuffer,</span><br><span class="line">		BUFSIZE</span><br><span class="line">		))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> != lstrlen(szDirveName))</span><br><span class="line">	&#123;</span><br><span class="line">		wprintf(TEXT(<span class="string">&quot;\nDrive Name is %s\n&quot;</span>), szDirveName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nVolume Serial Number is %u&quot;</span>, dwVolumeSerialNumber);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nMaximum Component Length is %u&quot;</span>, dwMaximumComponentLength);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nSystem Type is %s\n&quot;</span>, szFileSystemNameBuffer);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dwFileSystemFlags &amp; FILE_SUPPORTS_REPARSE_POINTS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The file system does not support volume mount points.\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (dwFileSystemFlags &amp; FILE_VOLUME_QUOTAS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The file system supports disk quotas.\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (dwFileSystemFlags &amp; FILE_CASE_SENSITIVE_SEARCH)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The file system supports case-sensitive file names.\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//you can use these value to get more informaion</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//FILE_CASE_PRESERVED_NAMES</span></span><br><span class="line">	<span class="comment">//FILE_CASE_SENSITIVE_SEARCH</span></span><br><span class="line">	<span class="comment">//FILE_FILE_COMPRESSION</span></span><br><span class="line">	<span class="comment">//FILE_NAMED_STREAMS</span></span><br><span class="line">	<span class="comment">//FILE_PERSISTENT_ACLS</span></span><br><span class="line">	<span class="comment">//FILE_READ_ONLY_VOLUME</span></span><br><span class="line">	<span class="comment">//FILE_SUPPORTS_ENCRYPTION</span></span><br><span class="line">	<span class="comment">//FILE_SUPPORTS_OBJECT_IDS</span></span><br><span class="line">	<span class="comment">//FILE_SUPPORTS_REPARSE_POINTS</span></span><br><span class="line">	<span class="comment">//FILE_SUPPORTS_SPARSE_FILES</span></span><br><span class="line">	<span class="comment">//FILE_UNICODE_ON_DISK</span></span><br><span class="line">	<span class="comment">//FILE_VOLUME_IS_COMPRESSED</span></span><br><span class="line">	<span class="comment">//FILE_VOLUME_QUOTAS</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;...\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="操作驱动器挂载点"><a href="#操作驱动器挂载点" class="headerlink" title="操作驱动器挂载点"></a>操作驱动器挂载点</h3><p>一般可以用FindFirstVolumeMountPoint系列的API来找到一个卷的所有挂载点；用GetVolumeNameForVolumeMountPoint来获取指定挂载点所指向的卷名，卷名形式为”//?/Volume{GUID}/”;用SetVolumeMountPoint来设置新的挂载点。</p>
<p>(1）FindFirstVolumeMountPoint.<br>获取指定卷的第一个挂载点，函数原型如下：<br>以用GetLastError()函数获取更详细的错误信息。<br>(2) FindNextVolumeMountPoint<br>查找指定卷的后继挂载点，函数原型如下：</p>
<p>（3）FindVolumeMountPointClose.<br>关闭FindVolumeMountPointClose打开的卷句柄，其函数原型如下：<br>◇参数<br>hFindVolumeMountPoint:要关闭的挂载点查找句柄。<br>◇返回值<br>(4)GetVolumeNameForVolumeMountPoint。<br>根据指定的挂载点获取相应的卷设备名，函数原型如下：</p>
<p>（5）SetVolumeMountPc<br>将指定卷挂载到指定挂载点处，函数原型如下：</p>
<h3 id="判断光驱"><a href="#判断光驱" class="headerlink" title="判断光驱"></a>判断光驱</h3><p>首先使用驱动器根路径作为GetDriveType和参数，如果返回值是DRIVE_CDROM，则说明此驱动器为光驱。然后使用GetVolumeInformation获取信息，如果成功，则说明存光盘已经放入。调用完成后GetVolumeInformation函数的第7个参数LPTSTR lpFileSystemNameBuffer存储的是文件系统的类别字符串，光盘一般是CDFS。如果调用GetVolumeInformation时返回FALSE，并且GetLastError返回21，则说明驱动器中未放入光盘。</p>
<p>1．关键API<br>(1）GetDiskType与GetVolumeInformation。<br>这两个API已经在4.2.1小节介绍过，这里不再赘述。<br>（2）GetLastError。<br>获取在执行中本线程最近的一次错误。本函数是很多系统API返回执行错误原因的方法。可能使用SetLastError函数设置本线程的Last-Error值。GetLastError函数原型如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WIN32_WINNT 0x0501</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFSIZE            MAX_PATH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILESYSNAMEBUFSIZE MAX_PATH</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,TCHAR argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//存储文件系统类别名</span></span><br><span class="line">	TCHAR szFileSystemNameBuffer[BUFSIZE];</span><br><span class="line">	DWORD dwLastError;</span><br><span class="line">	DWORD dwFileSystemFlags;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	//判断是否输入运行时参数</span></span><br><span class="line"><span class="comment">	if (argc != 2)</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		printf(&quot;请输入驱动器的根路径，比如： \&quot;D:\\\&quot;\n&quot;);</span></span><br><span class="line"><span class="comment">		return(-1);</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="comment">//判断输入的驱动器是否为CD\DVD ROM</span></span><br><span class="line">	<span class="keyword">if</span> (GetDriveType(TEXT(<span class="string">&quot;H:\\&quot;</span>)) != DRIVE_CDROM)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;驱动器 %s 不是 CD/DVD ROM。\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">		<span class="keyword">return</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取卷信息</span></span><br><span class="line">	<span class="keyword">if</span> (!GetVolumeInformation(</span><br><span class="line">		TEXT(<span class="string">&quot;H:\\&quot;</span>), <span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">		&amp;dwFileSystemFlags,</span><br><span class="line">		szFileSystemNameBuffer,</span><br><span class="line">		BUFSIZE</span><br><span class="line">		))</span><br><span class="line">	&#123;</span><br><span class="line">		dwLastError = GetLastError();</span><br><span class="line">		<span class="keyword">if</span> (dwLastError == <span class="number">21</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;设备未就绪,请放入光盘！\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;GetVolumeInformation 错误 %d\n&quot;</span>, dwLastError);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;光盘已经放入，文件系统类别 %ls。\n&quot;</span>, szFileSystemNameBuffer);</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="获取磁盘信息"><a href="#获取磁盘信息" class="headerlink" title="获取磁盘信息"></a>获取磁盘信息</h3><p>获取磁盘分区的总容量和空闲空间的容量可以使用GetDiskFreeSpace函数或GetDiskFree SpaceEx函数。GetDiskFreeSpace使用DWORD类型作为输出参数，由于DWOR长度为32位，最大只能表示4GB，而一般的磁盘分区大小都大于4GB，所以，GetDiskFreeSpace并不直接返回磁盘的总容量和空闲空间的容量，而是使用总簇数、空闲的簇数、每簇的扇区数、每扇区的字节数来表示。用户在编程时，可以使用它们的乘积来获得最终结果。而GetDiskFreeSpaceEx使用ULARGE_INTEGER (DWORD64)类型的数据来存储磁盘空间总空间和剩余空间，所以可以直接获得结果。DWORD64可以表示约16777216TB的数据量(DWORD64最大可表示2Byte，lTB=2Byte，</p>
<p>(2）GetDiskFreeSpacEX。<br>获取驱动器根路径作为输入，获取用户可用的空闲空间的字节数、空闲空间的字节数、磁盘总容量的字节数；</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 头文件　*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">* BOOL GetDiskSpaceInfo(LPCSTR pszDrive</span></span><br><span class="line"><span class="comment">* 功能	根据输入的驱动器，获取磁盘总容量</span></span><br><span class="line"><span class="comment">*			空闲空间、簇数量等磁盘信息</span></span><br><span class="line"><span class="comment">* 参数	驱动器根路径，比如“D:\”。</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"><span class="function">BOOL <span class="title">GetDiskSpaceInfo</span><span class="params">(LPCTSTR pszDrive)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD64 qwFreeBytesToCaller, qwTotalBytes, qwFreeBytes;</span><br><span class="line">	DWORD dwSectPerClust, dwBytesPerSect, dwFreeClusters, dwTotalClusters;</span><br><span class="line">	BOOL bResult;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//使用GetDiskFreeSpaceEx获取磁盘信息并打印结果</span></span><br><span class="line">	bResult = GetDiskFreeSpaceEx(pszDrive,</span><br><span class="line">		(PULARGE_INTEGER)&amp;qwFreeBytesToCaller,</span><br><span class="line">		(PULARGE_INTEGER)&amp;qwTotalBytes,</span><br><span class="line">		(PULARGE_INTEGER)&amp;qwFreeBytes);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bResult)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;使用GetDiskFreeSpaceEx获取磁盘空间信息\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;可获得的空闲空间（字节）: \t%I64d\n&quot;</span>, qwFreeBytesToCaller);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;空闲空间（字节）: \t\t%I64d\n&quot;</span>, qwFreeBytes);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;磁盘总容量（字节）: \t\t%I64d\n&quot;</span>, qwTotalBytes);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//使用GetDiskFreeSpace获取磁盘信息并打印结果</span></span><br><span class="line">	bResult = GetDiskFreeSpace(pszDrive,</span><br><span class="line">		&amp;dwSectPerClust,</span><br><span class="line">		&amp;dwBytesPerSect,</span><br><span class="line">		&amp;dwFreeClusters,</span><br><span class="line">		&amp;dwTotalClusters);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bResult)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n使用GetDiskFreeSpace获取磁盘空间信息\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;空闲的簇数量 : \t\t\t%d\n&quot;</span>, dwFreeClusters);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;总簇数量 : \t\t\t%d\n&quot;</span>, dwTotalClusters);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;每簇的扇区数量 : \t\t%d\n&quot;</span>, dwSectPerClust);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;每扇区的容量（字节）: \t\t%d\n&quot;</span>, dwBytesPerSect);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;空闲空间（字节）: \t\t%I64d\n&quot;</span>,</span><br><span class="line">			(DWORD64)dwFreeClusters*</span><br><span class="line">			(DWORD64)dwSectPerClust*(DWORD64)dwBytesPerSect);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;磁盘总容量（字节）: \t\t%I64d&quot;</span>,</span><br><span class="line">			(DWORD64)dwTotalClusters*</span><br><span class="line">			(DWORD64)dwSectPerClust*(DWORD64)dwBytesPerSect);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">* int main( int argc, PCHAR argv[] )</span></span><br><span class="line"><span class="comment">* 功能	应用程序主函数，根据输入参数</span></span><br><span class="line"><span class="comment">*			调用GetDiskSpaceInfo函数获取</span></span><br><span class="line"><span class="comment">*			磁盘空间信息</span></span><br><span class="line"><span class="comment">* 参数	驱动器根路径，比如“D:\”。</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, PCHAR argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GetDiskSpaceInfo(TEXT(<span class="string">&quot;C:\\&quot;</span>));</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="文件和目录管理"><a href="#文件和目录管理" class="headerlink" title="文件和目录管理"></a>文件和目录管理</h2><h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><p>Windows系统为文件的删除、复制、重命名或移动文件提供了相应的API函数。删除文件使用DeleteFile函数；复制文件使用CopyFile函数；重命名文件和移动文件实际是一个操作，使用MoveFile函数。这几个函数的使用都非常简单，下面分别介绍。<br>1．关键API<br>(1) DeleteFile。</p>
<p>DeleteFile的功能是删除文件。以文件路径作为输入，指向需要删除的文件。文件路径可以是类似于“c：/files/delete.txt”的绝对路径，也可以是类似于“./delete.txt”的相对路径，二相对于可执行文件所在的路径。</p>
<p>(2) CopyFile。<br>CopyFile的功能是复制文件。通过参数输入复制文件和源路径和目的路径，路径可以是绝对路径也可以是相对路径，还可以通过参数指明如果目的路径已经存在文件，是否覆盖。可以使用CopyFileEx函数进行更为高级的操作，比如在复制进行过程中取消复制等。CopyFileEx可以指定<br>一个回调函数来处理文件复制中所可能发生的各种情况。</p>
<ol start="3">
<li>MoveFile。<br>MoveFile的功能是移动、重命名文件和目录。通过参数输入源路径和目的路径，路径可以是绝对路径也可以是相对路径，如果目的路径的文件或目录已经存在，则返回失败。可以使用MoveFileEx函数来指定更多的选项，如果已经存在是否替换等。还可以使用MoveFileWithProgress指定一个回调函数来处理文件移动中所可能发生的各种情况。函数原型如下：</li>
</ol>
<p>(4) CopyFileEx、MoveFileEx以及MoveFileWithProgreSS.<br>这3个API函数功能更丰富，但是限于篇幅这里不再做详细介绍，读者可以使用SDK文档学习它们的使用方法。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, PCHAR argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//BOOL bFile = DeleteFile(TEXT(&quot;1.txt&quot;));</span></span><br><span class="line">	<span class="comment">//CopyFile(TEXT(&quot;1.txt&quot;), TEXT(&quot;2.txt&quot;), TRUE);		//设置为TURE不覆盖原有文件</span></span><br><span class="line">	<span class="comment">//MoveFile(TEXT(&quot;1.txt&quot;), TEXT(&quot;D:\\2.txt&quot;));		//移动文件</span></span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="创建文件"><a href="#创建文件" class="headerlink" title="创建文件"></a>创建文件</h3><p>1．关键API<br>（1）CreateFile<br>CreateFile是文件操作中最主要的一个函数。几乎所有的文件操作都需要使用到文件句柄。而CreateFile函数为这些操作建立文件句柄。CreateFile函数定义如下：</p>
<p>（2）ReadFile。</p>
<p>ReadFile动能是从文件中读出数据。需要使用CreateFile所返回的文件句柄。函数原型如下：</p>
<p>（3）WriteFile。<br>WriteFile函数的功能是将数据写入到文件中，写入到文件指针所在的位置，写入操作完成后，文件指针会移动到写入的数据之后，函数原型如下：</p>
<p>（4）GetFileSize、GetFileSizeEX.<br>GetFileSize、GetFileSizeEX的功能是一致的，都是获取文件大小，</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, PCHAR argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> BUFSIZE = <span class="number">4096</span>;</span><br><span class="line">	<span class="keyword">char</span> szFileBuffer[MAX_PATH];</span><br><span class="line">	<span class="keyword">char</span> szFileBuffer_Read[MAX_PATH];</span><br><span class="line">	<span class="built_in">memcpy</span>(szFileBuffer, <span class="string">&quot;sYstemk1t&quot;</span>, <span class="number">20</span>);</span><br><span class="line">	DWORD dwWriteSize = <span class="number">0</span>;</span><br><span class="line">	HANDLE hFile = CreateFile(TEXT(<span class="string">&quot;1.txt&quot;</span>), GENERIC_WRITE | GENERIC_READ, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (hFile == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateFile Error = %d\n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	BOOL bFile = WriteFile(hFile, szFileBuffer, <span class="number">20</span>, &amp;dwWriteSize, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (!bFile)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WriteFile Error = %d\n&quot;</span>, GetLastError());</span><br><span class="line">	&#125;</span><br><span class="line">	FlushFileBuffers(hFile);</span><br><span class="line"></span><br><span class="line">	LONG IDistance = <span class="number">0</span>;</span><br><span class="line">	DWORD dwPtr = SetFilePointer(hFile, IDistance, <span class="literal">NULL</span>, FILE_BEGIN);</span><br><span class="line">	<span class="keyword">if</span> (dwPtr == INVALID_FILE_ATTRIBUTES)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WriteFile Error = %d\n&quot;</span>, GetLastError());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DWORD dwReadSize = <span class="number">0</span>;</span><br><span class="line">	bFile = ReadFile(hFile, szFileBuffer_Read, <span class="number">20</span>, &amp;dwReadSize, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (!bFile)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WriteFile Error = %d\n&quot;</span>, GetLastError());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Buffer = %s\n&quot;</span>, szFileBuffer_Read);</span><br><span class="line"></span><br><span class="line">	CloseHandle(hFile);</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h3><p>1． 关键API<br>（1） Createdirectory<br>函数原型如下：<br>◇参数<br>lpPathName:输入参数，所要创建的目录名或路径。<br>lpSecurityAttributes:输入参数，设置为NULL。<br>◇返回值<br>返回BOOL值，表示是否成功。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!CreateDirectory(TEXT(<span class="string">&quot;test&quot;</span>), <span class="literal">NULL</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CrreateDirectory Error = %d\n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!CreateDirectory(TEXT(<span class="string">&quot;D:\\Test&quot;</span>), <span class="literal">NULL</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CrreateDirectory Error = %d\n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="获取目录信息"><a href="#获取目录信息" class="headerlink" title="获取目录信息"></a>获取目录信息</h3><p>用户可以使用<br>GetCurrentDirectory和SetCurrentDirectory获取程序的当前目录，获取模块的路径使用<br>GetModuleFileName，如果以NULL参数调用GetModuleFileName，将会返回当前模块的路径。如果在程序主模块(exe)中获取当前模块路径，便可以从当前模块的路径中提取出程序运行时所在的路径。<br>1．关键API<br>（1）GetCurrentDirectory。<br>获取进程的当前目录，函数原型如下：</p>
<p> （2）SetCurrentDirectory。<br>设置进程的当前目录，函数原型如下：</p>
<p>(3)GetModuleFileName。<br>获取模块文件名，当第一个参数为NULL时获取当前模块路径，</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">* int main(void)</span></span><br><span class="line"><span class="comment">* 功能	演示使用设置获取当前路径</span></span><br><span class="line"><span class="comment">*		演示获取模块路径</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//用于存储当前路径</span></span><br><span class="line">	TCHAR szCurrentDirectory[MAX_PATH];</span><br><span class="line">	<span class="comment">//用于存储模块路径</span></span><br><span class="line">	TCHAR szMoudlePath[MAX_PATH];</span><br><span class="line">	<span class="comment">//Kernel32文件名与句柄</span></span><br><span class="line">	LPTSTR szKernel32 = TEXT(<span class="string">&quot;kernel32.dll&quot;</span>);</span><br><span class="line">	HMODULE hKernel32;</span><br><span class="line">	<span class="comment">//当前路径的长度，也用于判断获取是否成功</span></span><br><span class="line">	DWORD dwCurDirPathLen;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取进程当前目录</span></span><br><span class="line">	dwCurDirPathLen =</span><br><span class="line">		GetCurrentDirectory(MAX_PATH, szCurrentDirectory);</span><br><span class="line">	<span class="keyword">if</span> (dwCurDirPathLen == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;获取当前目录错误。\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;进程当前目录为 %ls \n&quot;</span>, szCurrentDirectory);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将进程当前目录设置为“D:\”</span></span><br><span class="line">	lstrcpy(szCurrentDirectory, TEXT(<span class="string">&quot;D:\\&quot;</span>));</span><br><span class="line">	<span class="keyword">if</span> (!SetCurrentDirectory(szCurrentDirectory))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;设置当前目录错误。\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;已经设置当前目录为 %ls \n&quot;</span>, szCurrentDirectory);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//在当前目录下创建子目录“current_dir”</span></span><br><span class="line">	<span class="comment">//运行完成后C:盘下将出现文件夹“current_dir”</span></span><br><span class="line">	CreateDirectory(TEXT(<span class="string">&quot;current_dir&quot;</span>), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//再次获取系统当前目录</span></span><br><span class="line">	dwCurDirPathLen =</span><br><span class="line">		GetCurrentDirectory(MAX_PATH, szCurrentDirectory);</span><br><span class="line">	<span class="keyword">if</span> (dwCurDirPathLen == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;获取当前目录错误。\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;GetCurrentDirectory获取当前目录为 %ls \n&quot;</span>,</span><br><span class="line">		szCurrentDirectory);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//使用NULL参数，获取本模块的路径。</span></span><br><span class="line">	<span class="keyword">if</span> (!GetModuleFileName(<span class="literal">NULL</span>, szMoudlePath, MAX_PATH))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;获取模块路径录错误。\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;本模块路径 %ls \n&quot;</span>, szMoudlePath);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取Kernel32.dll的模块句柄。</span></span><br><span class="line">	hKernel32 = LoadLibrary(szKernel32);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//使用Kernel32.dll的模块句柄，获取其路径。</span></span><br><span class="line">	<span class="keyword">if</span> (!GetModuleFileName(hKernel32, szMoudlePath, MAX_PATH))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;获取模块路径错误。\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;kernel32模块路径 %ls \n&quot;</span>, szMoudlePath);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="遍历目录"><a href="#遍历目录" class="headerlink" title="遍历目录"></a>遍历目录</h3><p>Windows API中，有一组专门的函数和结构，用于遍历目录，它们是FindFirstFile函数、<br>FindNextFile函数和WIN32_FIND_DATA结构。使用FindFirstFile和FindNextFile函数并与do-while循环结合，可以完成遍历目录的任务<br>值得一提的是，FindFirstFile输入参数的路径需使用通配符，也就是用户可以根据一些条件来对查找的文件作简单的过滤。<br>1．关键API<br>（1）FindFirstFile。<br>查找第一个目录或文件，获取查找句柄，函数原型如下：</p>
<p>（2）FindNextFile<br>对文件、文件夹进行循环查找，函数原型如下：</p>
<p>2．关键结构<br>WIN32_FIND_DATA结构用于表示找到的文件，结构中包括文件、目录的名字，创建、最后访问和最后写入时间，文件大小、文件属性等。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">EnumerateFileInDrectory</span><span class="params">(LPTSTR szPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	WIN32_FIND_DATA FindFileData;</span><br><span class="line">	HANDLE hListFile;</span><br><span class="line">	TCHAR szFilePath[MAX_PATH];</span><br><span class="line"></span><br><span class="line">	<span class="comment">//构造代表子目录和文件夹路径的字符串，使用通配符“*”   </span></span><br><span class="line">	lstrcpy(szFilePath, szPath);</span><br><span class="line">	<span class="comment">//注释的代码可以用于查找所有以“.txt结尾”的文件。   </span></span><br><span class="line">	<span class="comment">//lstrcat(szFilePath, &quot;//*.txt&quot;);   </span></span><br><span class="line">	lstrcat(szFilePath, TEXT(<span class="string">&quot;//*&quot;</span>));</span><br><span class="line">	<span class="comment">//查找第一个文件/目录，获得查找句柄   </span></span><br><span class="line">	hListFile = FindFirstFile(szFilePath, &amp;FindFileData);</span><br><span class="line">	<span class="comment">//判断句柄   </span></span><br><span class="line">	<span class="keyword">if</span> (hListFile == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;错误：%d&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">/*  如果不想显示代表本级目录和上级目录的“.”和“..”，</span></span><br><span class="line"><span class="comment">			可以使用注释部分的代码过滤。</span></span><br><span class="line"><span class="comment">			if(lstrcmp(FindFileData.cFileName,TEXT(&quot;.&quot;))==0||</span></span><br><span class="line"><span class="comment">			lstrcmp(FindFileData.cFileName,TEXT(&quot;..&quot;))==0)</span></span><br><span class="line"><span class="comment">			&#123;</span></span><br><span class="line"><span class="comment">			continue;</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">			*/</span></span><br><span class="line">			<span class="comment">//打印文件名、目录名   </span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%ls/t/t&quot;</span>, FindFileData.cFileName);</span><br><span class="line">			<span class="comment">//判断文件属性，加密文件或文件夹   </span></span><br><span class="line">			<span class="keyword">if</span> (FindFileData.dwFileAttributes&amp;FILE_ATTRIBUTE_ENCRYPTED)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;&lt;加密&gt; &quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//判断文件属性，隐藏文件或文件夹   </span></span><br><span class="line">			<span class="keyword">if</span> (FindFileData.dwFileAttributes&amp;FILE_ATTRIBUTE_HIDDEN)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;&lt;隐藏&gt; &quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//判断文件属性，目录   </span></span><br><span class="line">			<span class="keyword">if</span> (FindFileData.dwFileAttributes&amp;FILE_ATTRIBUTE_DIRECTORY)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;&lt;DIR&gt; &quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//读者可根据文件属性表中的内容自行添加判断文件属性。   </span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		&#125; <span class="keyword">while</span> (FindNextFile(hListFile, &amp;FindFileData));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="获取设置文件属性"><a href="#获取设置文件属性" class="headerlink" title="获取设置文件属性"></a>获取设置文件属性</h3><p>为了获取文件属性，用户可以使用GetFileAttributes与GetFileAttributesEx函数。<br>GetFileAttributesEx函数除了返回文件属性外，还返回文件时间信息、文件大小等。<br>GetFileAttributesEx将返回结果保存在WIN32_FILE_ATTRIBUTE DATA结构中。<br>获取的文件时间是以FILETIME格式存在的，如果要正确显示，还需要对其时区进行调整，调整为本地时区，然后转换为系统时间格式，便于显示。<br>前面在获取文件大小时已经介绍，NTFS文件系统使用了64位数据来表示文件大小。因为32位的数据最多只能表示4GB的大小。Windows将其分为了高32位和低32位，两个都需要使用到，这一点尤其要在对大于4GB的文件操作时注意。<br>1．关键API<br>(1)GetFileAttributeS。<br>获取文件或目录的属牲-函数原型如下：</p>
<p>（2）GetFileAttributesEx。<br>获取文件或目录的属性、时间、大小，以WIN32_FILE ATTRIBUTE_DATA结构的形式返回<br>结果，函数原型如下：</p>
<p>(3) SetFileAttributes.<br>设置文件或目录的属性，函数原型如下：</p>
<p>（4）FileTimeToLocalFileTime。<br>把文件时间转换为本地的文件时间，函数原型如下：</p>
<p>5）FileTimeToSystemTime<br>将文件时间转换为系统时间（SYSTEMTIME格式），便于显示，函数原型如下：</p>
<p>2．关键数据结构<br>(1) FILETIM。<br>此结构用最小的数据量表示的时间，但是不便于用户查看和显示。通过API获取的系统时间都是这种格式的。如果要使用显示，可以使用FileTimeToSystemTime转换为便于显示的SYSTEMTIME结构。</p>
<p>(2) SYSTEMTIME。<br>此结构使用了较为直观的方式表示时间。</p>
<p>(3) WIN32_FILE ATTRIBUTE_DATA。<br>GetFileAttributesEx使用这个结构表示返回结果，包括文件属性、文件创建时间、文件最后访问时间、文件最后写入时间和文件大小。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 函数申明　*/</span></span><br><span class="line"><span class="function">DWORD <span class="title">ShowFileTime</span><span class="params">(PFILETIME lptime)</span></span>;</span><br><span class="line"><span class="function">DWORD <span class="title">ShowFileSize</span><span class="params">(DWORD dwFileSizeHigh, DWORD dwFileSizeLow)</span></span>;</span><br><span class="line"><span class="function">DWORD <span class="title">ShowFileAttrInfo</span><span class="params">(DWORD dwAttribute)</span></span>;</span><br><span class="line"><span class="function">DWORD <span class="title">SetFileHiddenAndReadonly</span><span class="params">(LPTSTR szFileName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">* DWORD ShowFileAttributes(LPSTR szPath)</span></span><br><span class="line"><span class="comment">* 功能	获取并显示文件属性，</span></span><br><span class="line"><span class="comment">*		调用ShowFileTime、ShowFileSize和</span></span><br><span class="line"><span class="comment">*		ShowFileAttrInfo函数</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 参数	LPTSTR szPath，获取并显示此文件的属性</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 返回值	0代表执行完成，1代码发生错误</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"><span class="function">DWORD <span class="title">ShowFileAttributes</span><span class="params">(LPTSTR szPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//文件属性结构</span></span><br><span class="line">	WIN32_FILE_ATTRIBUTE_DATA wfad;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;文件：%s\n&quot;</span>, szPath);</span><br><span class="line">	<span class="comment">//获取文件属性</span></span><br><span class="line">	<span class="keyword">if</span> (!GetFileAttributesEx(szPath,</span><br><span class="line">		GetFileExInfoStandard,</span><br><span class="line">		&amp;wfad))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;获取文件属性错误：%d\n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//显示相关时间</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;创建时间：\t&quot;</span>);</span><br><span class="line">	ShowFileTime(&amp;(wfad.ftCreationTime));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;最后访问时间：\t&quot;</span>);</span><br><span class="line">	ShowFileTime(&amp;(wfad.ftLastAccessTime));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;最后修改时间：\t&quot;</span>);</span><br><span class="line">	ShowFileTime(&amp;(wfad.ftLastWriteTime));</span><br><span class="line">	<span class="comment">//显示文件大小</span></span><br><span class="line">	ShowFileSize(wfad.nFileSizeHigh, wfad.nFileSizeLow);</span><br><span class="line">	<span class="comment">//显示文件属性</span></span><br><span class="line">	ShowFileAttrInfo(wfad.dwFileAttributes);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">* DWORD ShowFileAttrInfo(DWORD dwAttribute)</span></span><br><span class="line"><span class="comment">* 功能	打印将文件属性</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 参数	DWORD dwAttribute，文件属性</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 返回值 0</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"><span class="function">DWORD <span class="title">ShowFileAttrInfo</span><span class="params">(DWORD dwAttribute)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//依次判断属性，并显示。</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;文件属性：\t&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute&amp;FILE_ATTRIBUTE_ARCHIVE)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;&lt;ARCHIVE&gt; &quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute&amp;FILE_ATTRIBUTE_COMPRESSED)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;&lt;压缩&gt; &quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute&amp;FILE_ATTRIBUTE_DIRECTORY)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;&lt;目录&gt; &quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute&amp;FILE_ATTRIBUTE_ENCRYPTED)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;&lt;加密&gt; &quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute&amp;FILE_ATTRIBUTE_HIDDEN)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;&lt;隐藏&gt; &quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute&amp;FILE_ATTRIBUTE_NORMAL)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;&lt;NORMAL&gt; &quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute&amp;FILE_ATTRIBUTE_OFFLINE)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;&lt;OFFLINE&gt; &quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute&amp;FILE_ATTRIBUTE_READONLY)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;&lt;只读&gt; &quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute&amp;FILE_ATTRIBUTE_SPARSE_FILE)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;&lt;SPARSE&gt; &quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute&amp;FILE_ATTRIBUTE_SYSTEM)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;&lt;系统文件&gt; &quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute&amp;FILE_ATTRIBUTE_TEMPORARY)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;&lt;临时文件&gt; &quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">* DWORD ShowFileSize(DWORD dwFileSizeHigh, DWORD dwFileSizeLow)</span></span><br><span class="line"><span class="comment">* 功能	打印文件大小信息</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 参数	DWORD dwFileSizeHigh，文件大小高32位</span></span><br><span class="line"><span class="comment">*		DWORD dwFileSizeLow，文件大小低32位</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 返回值 0</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"><span class="function">DWORD <span class="title">ShowFileSize</span><span class="params">(DWORD dwFileSizeHigh, DWORD dwFileSizeLow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULONGLONG liFileSize;</span><br><span class="line">	liFileSize = dwFileSizeHigh;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//高们移动32位</span></span><br><span class="line">	liFileSize &lt;&lt;= <span class="keyword">sizeof</span>(DWORD) * <span class="number">8</span>;</span><br><span class="line">	liFileSize += dwFileSizeLow;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;文件大小：\t%I64u 字节\n&quot;</span>, liFileSize);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">*DWORD ShowFileTime(PFILETIME lptime)</span></span><br><span class="line"><span class="comment">* 功能	轮换文件时间，将打印</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 参数	PFILETIME lptime，指向文件时间的指针</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 返回值 0</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"><span class="function">DWORD <span class="title">ShowFileTime</span><span class="params">(PFILETIME lptime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//文件时间结构</span></span><br><span class="line">	FILETIME ftLocal;</span><br><span class="line">	<span class="comment">//系统时间结构</span></span><br><span class="line">	SYSTEMTIME st;</span><br><span class="line">	<span class="comment">//调整为系统所在时区的时间</span></span><br><span class="line">	FileTimeToLocalFileTime(</span><br><span class="line">		lptime,</span><br><span class="line">		&amp;ftLocal</span><br><span class="line">		);</span><br><span class="line">	<span class="comment">//将文件时间转换为SYSTEMTIME格式，便于显示。</span></span><br><span class="line">	FileTimeToSystemTime(</span><br><span class="line">		&amp;ftLocal,</span><br><span class="line">		&amp;st</span><br><span class="line">		);</span><br><span class="line">	<span class="comment">//显示时间信息字符串</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%4d年%.2d月%#02d日，%.2d:%.2d:%.2d\n&quot;</span>,</span><br><span class="line">		st.wYear, st.wMonth, st.wDay, st.wHour, st.wMinute, st.wSecond);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">* DWORD SetFileHiddenAndReadonly(LPSTR szFileName)</span></span><br><span class="line"><span class="comment">* 功能	将指定的文件设置为隐藏和只读</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 参数	LPSTR szFileName，文件路径</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 返回值 0</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"><span class="function">DWORD <span class="title">SetFileHiddenAndReadonly</span><span class="params">(LPTSTR szFileName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//获取原来的文件属性</span></span><br><span class="line">	DWORD dwFileAttributes = GetFileAttributes(szFileName);</span><br><span class="line">	<span class="comment">//将只读和隐藏属性附加到原来的文件属性上</span></span><br><span class="line">	dwFileAttributes |= FILE_ATTRIBUTE_READONLY;</span><br><span class="line">	dwFileAttributes |= FILE_ATTRIBUTE_HIDDEN;</span><br><span class="line">	<span class="comment">//设置文件属性，并判断是否成功。</span></span><br><span class="line">	<span class="keyword">if</span> (SetFileAttributes(szFileName, dwFileAttributes))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;文件%s的隐藏和属性设置成功\n&quot;</span>, szFileName);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;属性设置; %d\n&quot;</span>, GetLastError());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ************************************</span></span><br><span class="line"><span class="comment">* int main(int argc, PCHAR argv[])</span></span><br><span class="line"><span class="comment">* 功能	设置和获取文件属性等</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 参数	显示第一个参数指定文件的属性、时间、大小</span></span><br><span class="line"><span class="comment">*		将第二个参数的属性设置为隐藏、只读。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 返回值	0代表执行完成，1代码发生错误</span></span><br><span class="line"><span class="comment">**************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, LPTSTR argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;请输入参数\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;显示第一个参数指定文件的属性、时间、大小；\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;将第二个参数的属性设置为隐藏、只读。&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ShowFileAttributes((LPTSTR)argv[<span class="number">1</span>]);</span><br><span class="line">	SetFileHiddenAndReadonly(argv[<span class="number">2</span>]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="内存映射文件"><a href="#内存映射文件" class="headerlink" title="内存映射文件"></a>内存映射文件</h2><p>文件映射( mapping)是一种在将文件内容映射到进程的虚拟地址空间的技术。视图(View)是一段虚拟地址空间，进程可以通过View来存取文件的内容，视图是一段内存，可以使用指针来操作视图。使用的文件映射之后，读写文件就如同对读写内存一样简单。在使用文件映射时需要创建映射对象，映射对象分为命名的和未命名的。映射对象还存取权限。<br>使用文件映射至少有3个好处，一是因为文件是存储于硬盘上的，而文件视图是一段内存，使用文件映射操作时更方便；二是效率更高；三是可以在不同的进程间共享数据。<br>文件映射依赖于系统虚拟内存管理的分页机制。<br>本节将演示如何使用文件映射，下一节将演示如何使用文件映射来进行内存共享。<br>1． 关键API<br>（1）GetSystemInfo<br>获取系统信息<br>（2）CreateFileMapping。<br>创建mapping对象，函数原型如下</p>
<p>（3）MapViewOfFile。<br>创建视图，将文件mapping映射到当前进程内存虚拟地址空间。函数原型如下：</p>
<p> （4）FlushViewOfFile。<br>将视图中的文件数据写入到磁盘上。调用此参数后，对映射视图的内存操作将会及时反映到硬件中的文件。函数原型如下：</p>
<p>◇使用说明<br>如果不调用此函数，数据最终也会写回到硬盘，调用此函数后，数据会立刻写回到硬盘。<br>(5) FillMemory、CopyMemory。内存操作函数，分别为填充内存和复制内存</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFSIZE 1024</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILE_MAP_START 0x28804</span></span><br><span class="line">LPTSTR lpcTheFile = TEXT(<span class="string">&quot;test.dat&quot;</span>);</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hFileMap;			<span class="comment">//文件内存映射区域大小</span></span><br><span class="line">	HANDLE hFile;				<span class="comment">//文件句柄</span></span><br><span class="line">	DWORD dwByteWritten;		<span class="comment">//写入的字节数</span></span><br><span class="line">	DWORD dwFileSize;			<span class="comment">//文件大小</span></span><br><span class="line">	DWORD dwFileMapSize;		<span class="comment">//文件映射大小</span></span><br><span class="line">	DWORD dwMapViewSize;		<span class="comment">//视图的大小</span></span><br><span class="line">	DWORD dwFileMapStart;		<span class="comment">//文件映射起始地址</span></span><br><span class="line">	DWORD dwSysGran;			<span class="comment">///系统内存分配粒度</span></span><br><span class="line">	SYSTEM_INFO SysInfo;		<span class="comment">//系统信息</span></span><br><span class="line">	LPVOID lpMapAddress;		<span class="comment">//内存映射区域起始位置</span></span><br><span class="line">	PCHAR pData;				<span class="comment">//数据</span></span><br><span class="line">	INT i;						<span class="comment">//循环变量</span></span><br><span class="line">	INT iData;					</span><br><span class="line">	INT iViewDelta;</span><br><span class="line">	BYTE cMapBuffer[<span class="number">32</span>];		<span class="comment">//存储从mapping中计算出的数据</span></span><br><span class="line">	</span><br><span class="line">	hFile = CreateFile(lpcTheFile,</span><br><span class="line">		GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		CREATE_ALWAYS,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		<span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateFile Error : %d\n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">65535</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		WriteFile(hFile, &amp;i, <span class="keyword">sizeof</span>(i), &amp;dwByteWritten, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	dwFileSize = GetFileSize(hFile, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;文件大小%d:\n&quot;</span>, dwFileSize);</span><br><span class="line"></span><br><span class="line">	GetSystemInfo(&amp;SysInfo);</span><br><span class="line">	dwSysGran = SysInfo.dwAllocationGranularity;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//计算mapping的起始位置</span></span><br><span class="line">	dwFileMapStart = (FILE_MAP_START / dwSysGran) * dwSysGran;</span><br><span class="line">	<span class="comment">// 计算mapping view的大小</span></span><br><span class="line">	dwMapViewSize = (FILE_MAP_START % dwSysGran) + BUFFSIZE;</span><br><span class="line">	<span class="comment">// 计算mapping的大小</span></span><br><span class="line">	dwFileMapSize = FILE_MAP_START + BUFFSIZE;</span><br><span class="line">	<span class="comment">// 计算需要读取的数据的偏移</span></span><br><span class="line">	iViewDelta = FILE_MAP_START - dwFileMapStart;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建File mapping</span></span><br><span class="line">	hFileMap = CreateFileMapping(hFile,          <span class="comment">// 需要映射的文件的句柄</span></span><br><span class="line">		<span class="literal">NULL</span>,           <span class="comment">// 安全选项：默认</span></span><br><span class="line">		PAGE_READWRITE, <span class="comment">// 可读，可写</span></span><br><span class="line">		<span class="number">0</span>,              <span class="comment">// mapping对象的大小，高位</span></span><br><span class="line">		dwFileMapSize,  <span class="comment">// mapping对象的大小，低位</span></span><br><span class="line">		<span class="literal">NULL</span>);          <span class="comment">// mapping对象的名字</span></span><br><span class="line">	<span class="keyword">if</span> (hFileMap == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateFileMapping error: %d\n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 映射view</span></span><br><span class="line">	lpMapAddress = MapViewOfFile(hFileMap,            <span class="comment">// mapping对象的句柄</span></span><br><span class="line">		FILE_MAP_ALL_ACCESS, <span class="comment">// 可读，可写</span></span><br><span class="line">		<span class="number">0</span>,                   <span class="comment">// 映射的文件偏移，高32位</span></span><br><span class="line">		dwFileMapStart,      <span class="comment">// 映射的文件偏移，低32位</span></span><br><span class="line">		dwMapViewSize);      <span class="comment">// 映射到View的数据大小</span></span><br><span class="line">	<span class="keyword">if</span> (lpMapAddress == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;MapViewOfFile error: %d\n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;文件map view相对于文件的起始位置： 0x%x\n&quot;</span>,</span><br><span class="line">		dwFileMapStart);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;文件map view的大小：0x%x\n&quot;</span>, dwMapViewSize);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;文件mapping对象的大小：0x%x\n&quot;</span>, dwFileMapSize);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;从相对于map view 0x%x 字节的位置读取数据，&quot;</span>, iViewDelta);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将指向数据的指针偏移，到达我们关心的地方</span></span><br><span class="line">	pData = (PCHAR)lpMapAddress + iViewDelta;</span><br><span class="line">	<span class="comment">// 读取数据，赋值给变量</span></span><br><span class="line">	iData = *(PINT)pData;</span><br><span class="line">	<span class="comment">// 显示读取的数据</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;为：0x%.8x\n&quot;</span>, iData);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从mapping中复制数据，32个字节，并打印</span></span><br><span class="line">	CopyMemory(cMapBuffer, lpMapAddress, <span class="number">32</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;lpMapAddress起始的32字节是：&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;<span class="number">32</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;0x%.2x &quot;</span>, cMapBuffer[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 将mapping的前32个字节用0xff填充</span></span><br><span class="line">	FillMemory(lpMapAddress, <span class="number">32</span>, (BYTE)<span class="number">0xff</span>);</span><br><span class="line">	<span class="comment">// 将映射的数据写回到硬盘上</span></span><br><span class="line">	FlushViewOfFile(lpMapAddress, dwMapViewSize);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n已经将lpMapAddress开始的32字节使用0xff填充。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 关闭mapping对象</span></span><br><span class="line">	<span class="keyword">if</span> (!CloseHandle(hFileMap))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\nclosing the mapping object error %d!&quot;</span>,</span><br><span class="line">			GetLastError());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//关闭文件</span></span><br><span class="line">	<span class="keyword">if</span> (!CloseHandle(hFile))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\nError %ld occurred closing the file!&quot;</span>,</span><br><span class="line">			GetLastError());</span><br><span class="line">	&#125;</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>sYstemk1t
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://systemk1t.github.io/2021/06/23/WindowsAPI-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" title="WindowsAPI - 文件系统">http://systemk1t.github.io/2021/06/23/WindowsAPI-文件系统/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/WindowsAPI%E5%BC%80%E5%8F%91%E8%AF%A6%E8%A7%A3/" rel="tag"># WindowsAPI开发详解</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/22/Windows%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B-DLL%E5%9F%BA%E7%A1%80/" rel="prev" title="Windows核心编程 - DLL基础">
      <i class="fa fa-chevron-left"></i> Windows核心编程 - DLL基础
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/26/WindowsAPI-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="next" title="WindowsAPI - 内存管理">
      WindowsAPI - 内存管理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>





  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">1.</span> <span class="nav-text">文件系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5"><span class="nav-number">1.1.</span> <span class="nav-text">文件系统概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A3%81%E7%9B%98%E5%92%8C%E9%A9%B1%E5%8A%A8%E5%99%A8"><span class="nav-number">1.2.</span> <span class="nav-text">磁盘和驱动器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%8D%E5%8E%86%E5%8D%B7%E8%8E%B7%E5%BE%97%E5%B1%9E%E6%80%A7"><span class="nav-number">1.2.1.</span> <span class="nav-text">遍历卷获得属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E9%A9%B1%E5%8A%A8%E5%99%A8%E6%8C%82%E8%BD%BD%E7%82%B9"><span class="nav-number">1.2.2.</span> <span class="nav-text">操作驱动器挂载点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E5%85%89%E9%A9%B1"><span class="nav-number">1.2.3.</span> <span class="nav-text">判断光驱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%A3%81%E7%9B%98%E4%BF%A1%E6%81%AF"><span class="nav-number">1.2.4.</span> <span class="nav-text">获取磁盘信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95%E7%AE%A1%E7%90%86"><span class="nav-number">1.3.</span> <span class="nav-text">文件和目录管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="nav-number">1.3.1.</span> <span class="nav-text">文件操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6"><span class="nav-number">1.3.2.</span> <span class="nav-text">创建文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95"><span class="nav-number">1.3.3.</span> <span class="nav-text">创建目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%9B%AE%E5%BD%95%E4%BF%A1%E6%81%AF"><span class="nav-number">1.3.4.</span> <span class="nav-text">获取目录信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95"><span class="nav-number">1.3.5.</span> <span class="nav-text">遍历目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%AE%BE%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7"><span class="nav-number">1.3.6.</span> <span class="nav-text">获取设置文件属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6"><span class="nav-number">1.4.</span> <span class="nav-text">内存映射文件</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="sYstemk1t"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">sYstemk1t</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/sYstemk1t" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;sYstemk1t" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:sYstemk1t@126.com" title="E-Mail → mailto:sYstemk1t@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.baidu.com/" title="https:&#x2F;&#x2F;www.baidu.com&#x2F;" rel="noopener" target="_blank">Baidu</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sYstemk1t</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">390k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:54</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  















  

  

</body>
</html>
